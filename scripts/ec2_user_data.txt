#!/bin/bash

set -x

# Install additional dependencies
sudo apt update
sudo apt install mosh htop iftop

# Set automatic shutdown after 5 hours
sudo shutdown -P 60

# Login into ECR. This only works because we assigned
# the right IAM instance profile to the EC2 instance
$(aws ecr get-login --region eu-central-1 --no-include-email)

# Pull docker job
docker pull 693828385217.dkr.ecr.eu-central-1.amazonaws.com/autofl:latest

# Start docker job
docker run 693828385217.dkr.ecr.eu-central-1.amazonaws.com/autofl:latest train

# cancel previous shutdown and shutdown immediately after the job finishes
shutdown -c
shutdown -P now
