#!/bin/bash

set -x

# Set automatic shutdown after 1 hours
sudo shutdown -P 180

# Login into ECR. This only works because we assigned
# the right IAM instance profile to the EC2 instance
$(aws ecr get-login --region eu-central-1 --no-include-email)

# Pull docker job
docker pull 693828385217.dkr.ecr.eu-central-1.amazonaws.com/autofl:latest

# Start docker job
docker run -v $(pwd)/output:/opt/ml/project/output 693828385217.dkr.ecr.eu-central-1.amazonaws.com/autofl:latest train
docker run -v $(pwd)/output:/opt/ml/project/output 693828385217.dkr.ecr.eu-central-1.amazonaws.com/autofl:latest ./scripts/push_results.sh latest

# Cancel previous shutdown and shutdown 1m after the job finishes
# The machine is setup to terminate on shutdown
shutdown -c
shutdown -P 1
